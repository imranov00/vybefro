import React, { createContext, ReactNode, useContext, useEffect, useRef, useState } from 'react';
import { userApi, UserProfileResponse } from '../services/api';
import { ZodiacSign } from '../types/zodiac';
import { getToken } from '../utils/tokenStorage';

// User profili iÃ§in tip tanÄ±mÄ±
export type UserProfile = {
  id?: number;
  name: string;
  username: string;
  email?: string;
  firstName?: string;
  lastName?: string;
  birthDate?: string;
  gender?: string;
  zodiacSign?: ZodiacSign | string; // Enum veya string
  zodiacSignEmoji?: string; // Legacy destek
  zodiacSignTurkish?: string; // Legacy destek
  profileImage: string;
  bio: string;
};

// Context'in deÄŸer tipi
type ProfileContextType = {
  isProfileVisible: boolean;
  showProfile: () => void;
  hideProfile: () => void;
  userProfile: UserProfile;
  updateUserProfile: (profile: Partial<UserProfile>) => void;
  fetchUserProfile: () => Promise<void>;
  refreshProfile: () => Promise<void>;
  isLoading: boolean;
  error: string | null;
  currentUserId: string | null;
};

// VarsayÄ±lan deÄŸerler
const defaultUserProfile: UserProfile = {
  name: 'Ä°sim Soyisim',
  username: 'kullaniciadi',
  profileImage: 'https://picsum.photos/400',
  bio: 'KullanÄ±cÄ± biyografisi burada gÃ¶rÃ¼necek.',
};

// API yanÄ±tÄ±nÄ± UserProfile formatÄ±na dÃ¶nÃ¼ÅŸtÃ¼rÃ¼r
const mapApiResponseToUserProfile = (data: UserProfileResponse): UserProfile => {
  // Profil fotoÄŸrafÄ±na timestamp ekleyerek cache sorununu Ã§Ã¶z
  const profileImageUrl = data.profileImageUrl 
    ? `${data.profileImageUrl}?t=${Date.now()}` 
    : `https://picsum.photos/400?t=${Date.now()}`;
    
  return {
    id: data.id,
    name: `${data.firstName} ${data.lastName}`,
    username: data.username,
    email: data.email,
    firstName: data.firstName,
    lastName: data.lastName,
    birthDate: data.birthDate,
    gender: data.gender,
    zodiacSign: data.zodiacSign,
    zodiacSignEmoji: data.zodiacSignEmoji,
    zodiacSignTurkish: data.zodiacSignTurkish,
    profileImage: profileImageUrl,
    bio: data.bio || 'KullanÄ±cÄ± biyografisi burada gÃ¶rÃ¼necek.', // API'den gelen biyografi
  };
};

// Context'i oluÅŸtur
const ProfileContext = createContext<ProfileContextType | undefined>(undefined);

// Context provider bileÅŸeni
export function ProfileProvider({ children }: { children: ReactNode }) {
  const [isProfileVisible, setIsProfileVisible] = useState(false);
  const [userProfile, setUserProfile] = useState<UserProfile>(defaultUserProfile);
  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [currentUserId, setCurrentUserId] = useState<string | null>(null);
  const lastFetchTime = useRef<number>(0);
  const CACHE_DURATION = 5 * 60 * 1000; // 5 dakika cache sÃ¼resi

  const fetchProfile = async (force = false) => {
    const now = Date.now();
    
    // Cache kontrolÃ¼ - son 5 dakika iÃ§inde gÃ¼ncelleme yapÄ±ldÄ±ysa ve force false ise gÃ¼ncelleme yapma
    if (!force && now - lastFetchTime.current < CACHE_DURATION) {
      console.log('Cache\'den profil bilgileri kullanÄ±lÄ±yor');
      return;
    }

    setIsLoading(true);
    setError(null);
    
    try {
      console.log('Profil bilgileri API\'den getiriliyor...');
      const response = await userApi.getProfile();
      
      if (response) {
        const mappedProfile = mapApiResponseToUserProfile(response);
        
        // Token'dan ID'yi kontrol et ve set et
        const tokenUserId = await getCurrentUserId();
        if (tokenUserId && mappedProfile.id !== parseInt(tokenUserId)) {
          console.log('ðŸ”„ [PROFILE CONTEXT] Token ID ile API ID uyumsuz, token ID kullanÄ±lÄ±yor:', {
            apiId: mappedProfile.id,
            tokenId: tokenUserId
          });
          mappedProfile.id = parseInt(tokenUserId);
        }

        setUserProfile(mappedProfile);
        lastFetchTime.current = now;
        console.log('Profil baÅŸarÄ±yla gÃ¼ncellendi:', mappedProfile.name, 'ID:', mappedProfile.id);
      } else {
        setError('Profil bilgileri alÄ±namadÄ±');
        console.warn('API yanÄ±tÄ± boÅŸ');
      }
    } catch (err) {
      setError('Profil yÃ¼klenirken bir hata oluÅŸtu');
      console.error('Profil yÃ¼kleme hatasÄ±:', err);
    } finally {
      setIsLoading(false);
    }
  };

  const showProfile = async () => {
    setIsProfileVisible(true); // Drawer'Ä± aÃ§
    await fetchProfile(true); // Her drawer aÃ§Ä±lÄ±ÅŸÄ±nda gÃ¼ncel veri getir
  };

  const hideProfile = () => {
    setIsProfileVisible(false);
  };

  const updateUserProfile = (profile: Partial<UserProfile>) => {
    setUserProfile(prevProfile => ({ ...prevProfile, ...profile }));
  };

  const getCurrentUserId = async (): Promise<string | null> => {
    try {
      const token = await getToken();
      if (!token) return null;
      
      // JWT token'dan kullanÄ±cÄ± ID'sini parse et (basit yÃ¶ntem)
      // GerÃ§ek uygulamada daha gÃ¼venli bir yÃ¶ntem kullanÄ±lmalÄ±
      const payload = JSON.parse(atob(token.split('.')[1]));
      return payload.sub || payload.userId || payload.id || null;
    } catch (error) {
      console.error('Token parse hatasÄ±:', error);
      return null;
    }
  };

  const refreshProfile = async () => {
    await fetchProfile(true); // Force ile gÃ¼ncelleme
  };

  useEffect(() => {
    // Sadece ilk yÃ¼klemede kullanÄ±cÄ± bilgilerini kontrol et
    const initializeUser = async () => {
      const userId = await getCurrentUserId();
      setCurrentUserId(userId);
      
      if (userId) {
        // Ä°lk kez profil bilgilerini getir
        await fetchProfile();
      } else {
        // Logout durumu
        setUserProfile(defaultUserProfile);
        setError(null);
      }
    };

    initializeUser();
  }, []); // Sadece component mount olduÄŸunda Ã§alÄ±ÅŸÄ±r

  return (
    <ProfileContext.Provider
      value={{
        isProfileVisible,
        showProfile,
        hideProfile,
        userProfile,
        updateUserProfile,
        fetchUserProfile: fetchProfile,
        refreshProfile: refreshProfile,
        isLoading,
        error,
        currentUserId,
      }}
    >
      {children}
    </ProfileContext.Provider>
  );
}

// Context'i kullanmak iÃ§in hook
export function useProfile() {
  const context = useContext(ProfileContext);
  if (context === undefined) {
    throw new Error('useProfile must be used within a ProfileProvider');
  }
  return context;
}

// ProfileDrawer component'ini yeniden export et
export { default as ProfileDrawer } from '../components/profile/ProfileDrawer';

