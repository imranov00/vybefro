import { LinearGradient } from 'expo-linear-gradient';
import { useRouter } from 'expo-router';
import React, { useCallback, useEffect, useState } from 'react';
import {
    Dimensions,
    Platform,
    StatusBar,
    StyleSheet,
    Text,
    View
} from 'react-native';
import { PanGestureHandler } from 'react-native-gesture-handler';
import Animated, {
    runOnJS,
    useAnimatedGestureHandler,
    useAnimatedStyle,
    useSharedValue,
    withSpring
} from 'react-native-reanimated';
import { useSafeAreaInsets } from 'react-native-safe-area-context';

// Context imports
import { useAuth } from '../context/AuthContext';

// API imports
import { DiscoverUser, Match, swipeApi, userApi } from '../services/api';

// Component imports
import MatchScreen from '../components/match/MatchScreen';

// Swipe components
// @ts-ignore
import { ZodiacSwipeCard } from '../components/swipe/ZodiacSwipeCard';
// @ts-ignore  
import { PanelState, UserDetailPanel } from '../components/swipe/UserDetailPanel';

const { width: screenWidth, height: screenHeight } = Dimensions.get('window');

// Layout sabitleri
const LAYOUT_CONSTANTS = {
  statusBarHeight: Platform.OS === 'ios' ? 44 : StatusBar.currentHeight || 24,
  headerHeight: 60,
  tabBarHeight: Platform.OS === 'ios' ? 95 : 75,
  panelMaxHeight: screenHeight - (Platform.OS === 'ios' ? 44 : StatusBar.currentHeight || 24), // Tam ekran yÃ¼ksekliÄŸi
  panelMinHeight: 60,
};

const TOTAL_HEADER_HEIGHT = LAYOUT_CONSTANTS.headerHeight + LAYOUT_CONSTANTS.statusBarHeight;

const PANEL_POSITIONS = {
  [PanelState.CLOSED]: LAYOUT_CONSTANTS.panelMaxHeight - LAYOUT_CONSTANTS.panelMinHeight,
  [PanelState.HALF]: LAYOUT_CONSTANTS.panelMaxHeight * 0.5, // %50 aÃ§Ä±k
  [PanelState.FULL]: LAYOUT_CONSTANTS.panelMaxHeight * 0.1, // %90 aÃ§Ä±k (Ã¼stten %10 boÅŸluk)
};

export default function ZodiacSwipeScreen() {
  const router = useRouter();
  const { currentMode, switchMode } = useAuth();
  const insets = useSafeAreaInsets();
  
  // State
  const [users, setUsers] = useState<DiscoverUser[]>([]);
  const [currentUserIndex, setCurrentUserIndex] = useState(0);
  const [photoIndexes, setPhotoIndexes] = useState<{ [key: number]: number }>({});
  const [isLoading, setIsLoading] = useState(true);
  const [showMatchScreen, setShowMatchScreen] = useState(false);
  const [currentMatch, setCurrentMatch] = useState<Match | null>(null);
  const [currentUserProfile, setCurrentUserProfile] = useState<any>(null);
  const [panelState, setPanelState] = useState<PanelState>(PanelState.CLOSED);
  
  // Animation values
  const panelTranslateY = useSharedValue(PANEL_POSITIONS[PanelState.CLOSED]);
  
  // KullanÄ±cÄ±larÄ± yÃ¼kle
  const loadUsers = useCallback(async () => {
    try {
      setIsLoading(true);
      const response = await swipeApi.getDiscoverUsers(1, 20);
      setUsers(response.users);
      
      console.log('ðŸ‘¥ [ZodiacSwipe] KullanÄ±cÄ±lar yÃ¼klendi:', response.users.length);
      
      // FotoÄŸraf verilerini kontrol et
      response.users.forEach((user, index) => {
        console.log(`ðŸ“¸ [ZodiacSwipe] KullanÄ±cÄ± ${index + 1} (${user.firstName}):`, {
          id: user.id,
          profileImageUrl: user.profileImageUrl,
          photosCount: user.photos?.length || 0,
          photos: user.photos
        });
      });
      
      // FotoÄŸraf indekslerini baÅŸlat
      const initialIndexes: { [key: number]: number } = {};
      response.users.forEach(user => {
        initialIndexes[user.id] = 0;
      });
      setPhotoIndexes(initialIndexes);
      
      console.log('ðŸ“¸ [ZodiacSwipe] BaÅŸlangÄ±Ã§ fotoÄŸraf indeksleri:', initialIndexes);
    } catch (error) {
      console.error('KullanÄ±cÄ±lar yÃ¼klenirken hata:', error);
    } finally {
      setIsLoading(false);
    }
  }, []);

  // KullanÄ±cÄ± profilini yÃ¼kle
  const loadCurrentUserProfile = useCallback(async () => {
    try {
      const profile = await userApi.getProfile();
      setCurrentUserProfile(profile);
    } catch (error) {
      console.error('Profil yÃ¼klenirken hata:', error);
    }
  }, []);

  useEffect(() => {
    loadUsers();
    loadCurrentUserProfile();
  }, [loadUsers, loadCurrentUserProfile]);

  // Swipe iÅŸlemi
  const handleSwipe = useCallback(async (direction: 'left' | 'right' | 'up', userId: number) => {
    try {
      const action = direction === 'right' || direction === 'up' ? 'LIKE' : 'DISLIKE';
      
      const response = await swipeApi.swipe({
        targetUserId: userId.toString(),
        action
      });

      if (response.isMatch && response.matchId) {
        // EÅŸleÅŸme var - match screen gÃ¶ster
        const matchedUser = users.find(u => u.id === userId);
        if (matchedUser && currentUserProfile) {
          const matchData: Match = {
            id: parseInt(response.matchId),
            matchedUser: {
              id: matchedUser.id,
              username: matchedUser.firstName,
              firstName: matchedUser.firstName,
              lastName: matchedUser.lastName || '',
              age: matchedUser.age,
              profileImageUrl: matchedUser.profileImageUrl,
              zodiacSign: matchedUser.zodiacSign,
            },
            compatibilityScore: matchedUser.compatibilityScore,
            compatibilityDescription: matchedUser.compatibilityDescription,
            matchType: 'ZODIAC',
            matchedAt: new Date().toISOString(),
          };
          
          setCurrentMatch(matchData);
          setShowMatchScreen(true);
        }
      }

      // Sonraki kullanÄ±cÄ±ya geÃ§
      setCurrentUserIndex(prev => prev + 1);
      
      // KullanÄ±cÄ±lar biterse daha fazla yÃ¼kle
      if (currentUserIndex >= users.length - 3) {
        loadUsers();
      }
    } catch (error) {
      console.error('Swipe hatasÄ±:', error);
      // Hata olsa da sonraki kullanÄ±cÄ±ya geÃ§
      setCurrentUserIndex(prev => prev + 1);
    }
  }, [users, currentUserIndex, currentUserProfile, loadUsers]);

  // FotoÄŸraf indeksi gÃ¼ncelle
  const setPhotoIndex = useCallback((userId: number, index: number) => {
    console.log('ðŸ“¸ [ZodiacSwipe] FotoÄŸraf indeksi gÃ¼ncelleniyor:', { userId, index });
    
    setPhotoIndexes(prev => {
      const newIndexes = {
        ...prev,
        [userId]: index
      };
      console.log('ðŸ“¸ [ZodiacSwipe] Yeni fotoÄŸraf indeksleri:', newIndexes);
      return newIndexes;
    });
  }, []);

  // Panel gesture handler
  const panelGestureHandler = useAnimatedGestureHandler({
    onStart: () => {
      'worklet';
    },
    onActive: (event) => {
      'worklet';
      const newTranslateY = Math.max(
        PANEL_POSITIONS[PanelState.FULL],
        Math.min(
          PANEL_POSITIONS[PanelState.CLOSED],
          event.translationY + PANEL_POSITIONS[panelState]
        )
      );
      panelTranslateY.value = newTranslateY;
    },
    onEnd: (event) => {
      'worklet';
      const velocity = event.velocityY;
      const currentY = panelTranslateY.value;
      
      let targetState = PanelState.CLOSED;
      
      // HÄ±zlÄ± yukarÄ± Ã§ekme - direkt tam aÃ§
      if (velocity < -1200) {
        targetState = PanelState.FULL;
      } 
      // HÄ±zlÄ± aÅŸaÄŸÄ± itme - kapat
      else if (velocity > 1200) {
        targetState = PanelState.CLOSED;
      } 
      // Pozisyona gÃ¶re karar ver - 3 seviyeli sistem
      else {
        const panelHeight = LAYOUT_CONSTANTS.panelMaxHeight;
        const currentPosition = currentY / panelHeight;
        
        if (currentPosition < 0.25) {
          // Ãœst %25'te - tam aÃ§
          targetState = PanelState.FULL;
        } else if (currentPosition < 0.65) {
          // Orta bÃ¶lge - yarÄ±m aÃ§
          targetState = PanelState.HALF;
        } else {
          // Alt bÃ¶lge - kapat
          targetState = PanelState.CLOSED;
        }
      }
      
      panelTranslateY.value = withSpring(PANEL_POSITIONS[targetState], {
        damping: 20,
        stiffness: 300,
      });
      
      runOnJS(setPanelState)(targetState);
    },
  });

  // Animated styles
  const panelAnimatedStyle = useAnimatedStyle(() => ({
    transform: [{ translateY: panelTranslateY.value }],
  }));

  // Match screen kapatma
  const handleCloseMatch = useCallback(() => {
    setShowMatchScreen(false);
    setCurrentMatch(null);
  }, []);

  const handleSendMessage = useCallback(() => {
    // MesajlaÅŸma Ã¶zelliÄŸi henÃ¼z yok
    console.log('Mesaj gÃ¶nder:', currentMatch?.matchedUser.firstName);
    handleCloseMatch();
  }, [currentMatch, handleCloseMatch]);

  // Mevcut kullanÄ±cÄ±
  const currentUser = users[currentUserIndex];
  const currentPhotoIndex = currentUser ? photoIndexes[currentUser.id] || 0 : 0;

  return (
    <View style={styles.container}>
      <StatusBar barStyle="light-content" backgroundColor="transparent" translucent={true} />
      
      {/* Arka plan gradyan */}
      <LinearGradient
        colors={['#1a1a2e', '#16213e', '#0f3460']}
        style={styles.background}
      />

      {/* Ana iÃ§erik alanÄ± */}
      <View style={styles.mainContent}>
        {/* Swipe kartlarÄ± */}
        <View style={styles.cardsContainer}>
          {isLoading ? (
            <View style={styles.loadingContainer}>
              <Text style={styles.loadingText}>YÄ±ldÄ±zlar HizalanÄ±yor...</Text>
            </View>
          ) : currentUser ? (
            <>
              {/* Sonraki kartlar (stack efekti) */}
              {users.slice(currentUserIndex + 1, currentUserIndex + 3).map((user, index: number) => (
                <ZodiacSwipeCard
                  key={user.id}
                  user={user}
                  onSwipe={handleSwipe}
                  isTop={false}
                  style={[
                    styles.stackCard,
                    {
                      transform: [
                        { scale: 1 - (index + 1) * 0.05 },
                        { translateY: (index + 1) * 10 },
                      ],
                      opacity: 1 - (index + 1) * 0.3,
                    }
                  ]}
                  photoIndex={photoIndexes[user.id] || 0}
                  setPhotoIndex={setPhotoIndex}
                />
              ))}
              
              {/* Ãœstteki kart (aktif) */}
              <ZodiacSwipeCard
                key={currentUser.id}
                user={currentUser}
                onSwipe={handleSwipe}
                isTop={true}
                photoIndex={currentPhotoIndex}
                setPhotoIndex={setPhotoIndex}
              />
            </>
          ) : (
            <View style={styles.noUsersContainer}>
              <Text style={styles.noUsersText}>Åžimdilik bu kadar!</Text>
              <Text style={styles.noUsersSubtext}>Yeni kullanÄ±cÄ±lar iÃ§in daha sonra tekrar gel</Text>
            </View>
          )}
        </View>
      </View>

      {/* Alt panel */}
      <PanGestureHandler onGestureEvent={panelGestureHandler}>
        <Animated.View style={[styles.bottomPanel, panelAnimatedStyle]}>
          <UserDetailPanel 
            user={currentUser}
            panelState={panelState}
            onClose={() => {
              panelTranslateY.value = withSpring(PANEL_POSITIONS[PanelState.CLOSED]);
              setPanelState(PanelState.CLOSED);
            }}
            onPanelStateChange={(newState: PanelState) => {
              panelTranslateY.value = withSpring(PANEL_POSITIONS[newState], {
                damping: 20,
                stiffness: 300,
              });
              setPanelState(newState);
            }}
          />
        </Animated.View>
      </PanGestureHandler>

      {/* Match Screen */}
      {showMatchScreen && currentMatch && currentUserProfile && (
        <MatchScreen
          match={currentMatch}
          currentUser={currentUserProfile}
          onClose={handleCloseMatch}
          onSendMessage={handleSendMessage}
        />
      )}
    </View>
  );
}

const styles = StyleSheet.create({
  container: {
    flex: 1,
  },
  background: {
    position: 'absolute',
    width: screenWidth,
    height: screenHeight,
  },
  mainContent: {
    flex: 1,
    paddingTop: LAYOUT_CONSTANTS.statusBarHeight,
    paddingBottom: LAYOUT_CONSTANTS.tabBarHeight,
  },
  cardsContainer: {
    flex: 1,
    alignItems: 'center',
    justifyContent: 'center',
    paddingHorizontal: 20,
  },
  stackCard: {
    position: 'absolute',
  },
  loadingContainer: {
    alignItems: 'center',
    justifyContent: 'center',
  },
  loadingText: {
    fontSize: 18,
    color: 'rgba(255, 255, 255, 0.8)',
    fontWeight: '600',
  },
  noUsersContainer: {
    alignItems: 'center',
    justifyContent: 'center',
  },
  noUsersText: {
    fontSize: 24,
    fontWeight: 'bold',
    color: 'white',
    marginBottom: 8,
  },
  noUsersSubtext: {
    fontSize: 16,
    color: 'rgba(255, 255, 255, 0.7)',
    textAlign: 'center',
  },
  bottomPanel: {
    position: 'absolute',
    bottom: LAYOUT_CONSTANTS.tabBarHeight,
    left: 0,
    right: 0,
    height: LAYOUT_CONSTANTS.panelMaxHeight,
    borderTopLeftRadius: 25,
    borderTopRightRadius: 25,
    ...Platform.select({
      ios: {
        shadowColor: '#000',
        shadowOffset: { width: 0, height: -5 },
        shadowOpacity: 0.3,
        shadowRadius: 15,
      },
      android: {
        elevation: 15,
      },
    }),
  },
}); 